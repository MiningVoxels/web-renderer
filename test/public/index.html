<!DOCTYPE html>
<html lang="en">
    <head>
        <title>@wharfkit/web-ui-renderer</title>

        <script src="./bundle.js"></script>
        <script>
            const {WalletPluginPrivateKey, SessionKit, Session} = WebUIRenderer

            const chains = [
                {
                    id: '73e4385a2708e6d7048834fbc1079f2fabb17b3c125b146af438971e90716c4d',
                    url: 'https://jungle4.greymass.com',
                },
                {
                    id: 'aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906',
                    url: 'https://eos.greymass.com',
                },
            ]

            const permissionLevel = 'wharfkittest@test'

            const walletPlugin1 = new WalletPluginPrivateKey({
                privateKey: '5Jtoxgny5tT7NiNFp1MLogviuPJ9NniWjnU4wKzaX4t7pL4kJ8s',
            })

            const walletPlugin2 = new WalletPluginPrivateKey({
                privateKey: '5JAsUbwp2orxHRHRf59CR2GWuVVPioXWoiK9PnRTvNX8vCE5QBH',
            })

            const ui = new WebUIRenderer()

            const sessionKit = new SessionKit({
                appName: 'demo-app',
                chains,
                ui,
                walletPlugins: [walletPlugin1, walletPlugin2],
            })

            let session

            // Uncomment to automatically create a logged in session for testing
            // session = new Session({
            //     chain,
            //     permissionLevel,
            //     ui,
            //     walletPlugin,
            // })

            // tries to restore session, called when document is loaded
            function restoreSession() {
                console.log('restoreSession (NYI)')
                // If the session was defined, set the UI to logged in
                if (session) {
                    didLogin()
                    transfer()
                }
                // link.restoreSession(identifier).then((result) => {
                //     session = result
                //     if (session) {
                //         didLogin()
                //     }
                // })
            }

            // login and store session if successful
            function login() {
                console.log('login')
                sessionKit.login().then((result) => {
                    console.log('successful', result)
                    session = result.session
                    didLogin()
                })
            }

            // logout and remove session from storage
            function logout() {
                console.log('logout')
                document.body.classList.remove('logged-in')
                session = undefined
            }

            // called when session was restored or created
            function didLogin() {
                console.log('didLogin')
                document.getElementById('account-name').textContent = session.actor
                document.getElementById('account-permission').textContent = session.permission
                document.getElementById('chain-id').textContent = session.chain.name
                document.body.classList.add('logged-in')
                // document.getElementById('session-dump').textContent = JSON.stringify(session)
            }

            // transfer tokens using a session
            function transfer() {
                console.log('transfer')
                const action = {
                    account: 'eosio.token',
                    name: 'transfer',
                    authorization: [session.permissionLevel],
                    data: {
                        from: session.actor,
                        to: 'teamgreymass',
                        quantity: '0.0001 EOS',
                        memo: 'Yay WharfKit! Thank you <3',
                    },
                }
                session.transact({action}, {broadcast: false}).then((result) => {
                    console.log(result)
                    document.getElementById(
                        'log'
                    ).innerHTML += `Transaction broadcast! ${result.resolved.transaction.id}\n`
                })
            }
        </script>
        <style>
            .logged-in #login-ui {
                display: none;
            }
            #app-ui {
                display: none;
            }
            .logged-in #app-ui {
                display: block;
            }
        </style>
    </head>
    <body onload="restoreSession()">
        <h2>WharfKit Web UI Renderer Test</h2>
        <div id="app-ui">
            <code><pre id="session-dump"></pre></code>
            <p>Actor: <b id="account-name">undefined</b></p>
            <p>Permission: <b id="account-permission">undefined</b></p>
            <p>Chain: <b id="chain-id">undefined</b></p>
            <ul>
                <li><button onclick="transfer()">Test transfer</button></li>
                <li><button onclick="logout()">Log out</button></li>
            </ul>
            <h4>Log</h4>
            <pre id="log"></pre>
        </div>
        <div id="login-ui">
            <button onclick="login()">Login</button>
        </div>
    </body>
</html>
