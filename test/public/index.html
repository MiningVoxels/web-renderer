<!DOCTYPE html>
<html lang="en">
    <head>
        <title>@wharfkit/web-ui-renderer</title>

        <script src="./bundle.js"></script>
        <script>
            const {
                abiEncode,
                Asset,
                Bytes,
                TransactPluginAutoCorrect,
                // WalletPluginAnchor,
                WalletPluginMock,
                WalletPluginPrivateKey,
                WalletPluginWAX,
                PackedTransaction,
                Serializer,
                SessionKit,
                Session,
                SignedTransaction,
                Transaction,
            } = WebUIRenderer

            const chains = [
                {
                    id: '73e4385a2708e6d7048834fbc1079f2fabb17b3c125b146af438971e90716c4d',
                    url: 'https://jungle4.greymass.com',
                },
                // {
                //     id: 'aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906',
                //     url: 'https://eos.greymass.com',
                // },
                {
                    id: '1064487b3cd1a897ce03ae5b6a865651747e2e152090f99c1d19d44e01aea5a4',
                    url: 'https://wax.greymass.com',
                },
                // {
                //     id: 'f16b1833c747c43682f4386fca9cbb327929334a762755ebec17f6f23c9b8a12',
                //     url: 'https://waxtestnet.greymass.com',
                // },
            ]

            const permissionLevel = 'wharfkit1111@test'

            // const anchorPlugin = new WalletPluginAnchor()
            const mockPlugin = new WalletPluginMock()
            const waxPlugin = new WalletPluginWAX()

            const privateKeyPlugin = new WalletPluginPrivateKey(
                '5Jtoxgny5tT7NiNFp1MLogviuPJ9NniWjnU4wKzaX4t7pL4kJ8s'
            )

            const ui = new WebUIRenderer()

            const sessionKit = new SessionKit({
                appName: 'demo-app',
                chains,
                ui,
                transactPlugins: [new TransactPluginAutoCorrect()],
                // allowModify: false,
                // walletPlugins: [anchorPlugin],
                // walletPlugins: [mockPlugin],
                // walletPlugins: [waxPlugin],
                walletPlugins: [mockPlugin, waxPlugin, privateKeyPlugin],
                // walletPlugins: [privateKeyPlugin],
            })

            let session
            let account

            // Uncomment to automatically create a logged in session for testing
            // session = new Session({
            //     chain,
            //     permissionLevel,
            //     ui,
            //     walletPlugin,
            // })

            // tries to restore session, called when document is loaded
            async function restoreSession() {
                // export interface RestoreArgs {
                //     chain: Checksum256Type
                //     actor: NameType
                //     permission: NameType
                //     walletPlugin: Record<string, any>
                // }
                session = await sessionKit.restore()
                updateSessions()
                // If the session was defined, set the UI to logged in
                if (session) {
                    didLogin()
                    refreshAccount()
                }
                // link.restoreSession(identifier).then((result) => {
                //     session = result
                //     if (session) {
                //         didLogin()
                //     }
                // })
            }

            async function updateSessions() {
                const sessions = await sessionKit.getSessions()
                const container = document.getElementById('sessions')
                container.innerHTML = ''
                sessions.forEach((s) => {
                    const child = document.createElement('li')
                    const button = document.createElement('button')
                    button.textContent = `${s.actor} (${s.permission}) on ${s.chain}`
                    child.appendChild(button)
                    button.onclick = () => {
                        sessionKit.restore(s).then((result) => {
                            session = result
                            didLogin()
                            refreshAccount()
                        })
                    }
                    container.appendChild(child)
                })
            }

            // login and store session if successful
            function login() {
                sessionKit
                    .login({
                        // permissionLevel,
                    })
                    .then((result) => {
                        session = result.session
                        didLogin()
                        refreshAccount()
                        // setTimeout(() => {
                        //     transfer()
                        // }, 500)
                    })
            }

            function refreshAccount() {
                session.client.v1.chain.get_account(session.actor).then((result) => {
                    account = result
                    document.getElementById('account-balance').textContent =
                        account.core_liquid_balance ? account.core_liquid_balance : '0.0000'
                })
            }

            // logout and remove session from storage
            async function logout() {
                // Logout the current session
                await sessionKit.logout(session)
                const sessions = await sessionKit.getSessions()
                if (sessions) {
                    if (!sessions.length) {
                        document.body.classList.remove('logged-in')
                        session = undefined
                        account = undefined
                    } else {
                        session = await sessionKit.restore(sessions[0])
                        account = undefined
                        didLogin()
                        refreshAccount()
                    }
                } else {
                    document.body.classList.remove('logged-in')
                    session = undefined
                    account = undefined
                }
            }

            async function logoutAll() {
                // Logout all sessions
                await sessionKit.logout()
                document.body.classList.remove('logged-in')
                session = undefined
                account = undefined
            }

            // called when session was restored or created
            function didLogin() {
                updateSessions()
                document.getElementById('account-name').textContent = session.actor
                document.getElementById('account-permission').textContent = session.permission
                document.getElementById('chain-id').textContent = session.chain.name
                document.body.classList.add('logged-in')
            }

            // transfer tokens using a session
            function transfer() {
                const action = {
                    account: 'eosio.token',
                    name: 'transfer',
                    authorization: [session.permissionLevel],
                    data: {
                        from: session.actor,
                        to: 'teamgreymass',
                        // Use minimum value for test transfers
                        quantity: account.core_liquid_balance
                            ? Asset.fromUnits(1, account.core_liquid_balance.symbol)
                            : '0.0001 EOS',
                        // quantity: Asset.from('1.00000000 WAX'),
                        memo: 'Yay WharfKit! Thank you <3',
                    },
                }
                session
                    .transact(
                        {action},
                        {
                            // broadcast: false,
                            broadcast: true,
                        }
                    )
                    .then((result) => {
                        document.getElementById(
                            'log'
                        ).innerHTML += `Transaction broadcast! ${result.resolved.transaction.id}\n`
                    })
            }

            setInterval(() => {
                if (session) {
                    // refreshAccount()
                }
            }, 1000)
        </script>
        <style>
            .logged-in #login-ui {
                display: none;
            }
            #app-ui {
                display: none;
            }
            .logged-in #app-ui {
                display: block;
            }
        </style>
    </head>
    <body onload="restoreSession()">
        <h2>WharfKit Web UI Renderer Test</h2>
        <div id="app-ui">
            <code><pre id="session-dump"></pre></code>
            <p>Actor: <b id="account-name">undefined</b></p>
            <p>Permission: <b id="account-permission">undefined</b></p>
            <p>Chain: <b id="chain-id">undefined</b></p>
            <p>Core Balance: <b id="account-balance">undefined</b></p>
            <h3>Actions</h3>
            <ul>
                <li><button onclick="transfer()">Test transfer</button></li>
                <li><button onclick="login()">Login new account</button></li>
                <li><button onclick="refreshAccount()">Refresh account</button></li>
                <li><button onclick="logout()">Log out</button></li>
                <li><button onclick="logoutAll()">Log out all sessions</button></li>
            </ul>
            <h3>Accounts</h3>
            <ul id="sessions"></ul>
            <h4>Log</h4>
            <pre id="log"></pre>
        </div>
        <div id="login-ui">
            <button onclick="login()">Login</button>
        </div>
    </body>
</html>
